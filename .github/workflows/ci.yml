name: CI Pipeline

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch: # Allow manual triggering

jobs:
    lint:
        name: Code Quality (Lint)
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run ESLint
              run: npm run lint

            - name: Check TypeScript types
              run: npx tsc --noEmit

    test:
        name: Test Suite
        runs-on: ubuntu-latest
        needs: lint
        strategy:
            matrix:
                node-version: [18, 20]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run component smoke tests
              run: |
                  echo "Running basic component checks..."
                  node -e "
                    const fs = require('fs');
                    console.log('Checking project structure...');
                    
                    // Check key directories exist
                    const dirs = ['src/components', 'src/app', 'src/data', 'src/lib'];
                    dirs.forEach(dir => {
                      if (fs.existsSync(dir)) {
                        console.log('âœ“ Found:', dir);
                      } else {
                        console.log('âœ— Missing:', dir);
                        process.exit(1);
                      }
                    });
                  "

            - name: Check for test script
              run: |
                  if npm run test --dry-run >/dev/null 2>&1; then
                    echo "Running configured tests..."
                    npm test
                  else
                    echo "No test script configured - this is fine for now"
                  fi

    build:
        name: Build Project
        runs-on: ubuntu-latest
        needs: [lint, test]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Install dependencies
              run: npm run pre-push

            - name: Build project
              run: npm run build
              env:
                  NODE_ENV: production

            - name: Verify build output
              run: |
                  if [ ! -d "out" ]; then
                    echo "âŒ Build failed - no output directory"
                    exit 1
                  fi
                  echo "âœ… Build successful"
                  echo "ðŸ“ Build output:"
                  ls -la out/ | head -20

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: production-build
                  path: out/
                  retention-days: 7

    summary:
        name: CI Summary
        runs-on: ubuntu-latest
        needs: [lint, test, build]
        if: always()
        steps:
            - name: Check CI Status
              run: |
                  echo "## CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ needs.lint.result }}" == "success" ]; then
                    echo "âœ… Linting: Passed" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "âŒ Linting: Failed" >> $GITHUB_STEP_SUMMARY
                  fi

                  if [ "${{ needs.test.result }}" == "success" ]; then
                    echo "âœ… Tests: Passed" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "âŒ Tests: Failed" >> $GITHUB_STEP_SUMMARY
                  fi

                  if [ "${{ needs.build.result }}" == "success" ]; then
                    echo "âœ… Build: Passed" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "âŒ Build: Failed" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "Ready for deployment: ${{ needs.lint.result == 'success' && needs.test.result == 'success' && needs.build.result == 'success' }}" >> $GITHUB_STEP_SUMMARY
